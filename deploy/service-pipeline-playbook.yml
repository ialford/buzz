---
- name: Deploy Buzz pipeline build using CloudFormation
  hosts:
    buzz-pipeline-libnd
#    - buzz-pipeline-oregon
  connection: local
  gather_facts: false
  become: false
  vars_files:
    - ./vars/oauth.yml
  vars:
    template: cloudformation/service-pipeline.yml
    template_parameters:
      PrepEnvPath: '{{ PrepEnvPath }}'
      ProdEnvPath: '{{ ProdEnvPath }}'
      Approvers: '{{ Approvers }}'
      CDBranchName: '{{ CDBranchName }}'
      OAuth: '{{ OAuth_token }}'
      InfrastructureStackName: '{{ tagService }}-app-infrastructure'
      NetworkStackName: '{{ NetworkStackName }}'
      ProdServiceStackName: '{{ tagService }}-service-prod'
      TestServiceStackName: '{{ tagService }}-service-prep'
      TestUrlPath: '{{ TestUrlPath }}'
      RDSSecurityGroup: '{{ RDSSecurityGroup }}'
    stack_tags:
      Name: '{{ tagName }}'
      Owner: '{{ tagOwner }}'
      Contact: '{{ tagContact }}'
      Description: '{{ tagDescription }}'
      Service: '{{ tagService }}'
  tasks:
    - name: Launch application infrastructure Cloud Formation
      cloudformation:
        state: present
        template: '{{ template }}'
        stack_name: '{{ tagService }}-service-pipeline'
        template_parameters: '{{ template_parameters }}'
        tags: '{{ stack_tags }}'
      register: aws_cf_stack
